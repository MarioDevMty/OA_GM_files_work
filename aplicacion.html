<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retos - Aplicación de Funciones</title>
    
    <!-- CSS Organizado -->
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/components/navigation.css">
    <link rel="stylesheet" href="css/components/buttons.css">
    <link rel="stylesheet" href="css/components/cards.css">
    <link rel="stylesheet" href="css/components/forms.css">
    <link rel="stylesheet" href="css/components/blockly-ui.css">
    <link rel="stylesheet" href="css/components/common-components.css">
    <link rel="stylesheet" href="css/components/function-display.css">
    <link rel="stylesheet" href="css/pages/aplicacion.css">
    
    <!-- Librerías Blockly -->
    <script src="https://www.google.com/jsapi"></script>
    <script src="https://unpkg.com/blockly@12.0.0/blockly_compressed.js"></script>
    <script src="https://unpkg.com/blockly@12.0.0/blocks_compressed.js"></script>
    <script src="https://unpkg.com/blockly@12.0.0/javascript_compressed.js"></script>
    <script src="https://unpkg.com/blockly@12.0.0/msg/es.js"></script>
    <script src="https://unpkg.com/@blockly/theme-modern@7.0.1/dist/index.js"></script>
    
    <!-- MathJax -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>

<body>
    <nav class="nav-dots">
        <ul>
            <li><a href="index.html">1</a></li>
            <li><a href="teoria.html">2</a></li>
            <li><a href="grafico.html">3</a></li>
            <li><a href="aplicacion.html" class="active">4</a></li>
            <li><a href="evaluacion.html">5</a></li>
        </ul>
    </nav>

    <main class="main-content">
        <div class="logo-container">
            <img src="assets/Uanl-color-negro.png" alt="UANL" class="logo left-logo">
            <img src="assets/Logo-Excelencia-Negro.png" alt="Excelencia" class="logo right-logo">
        </div>
        <div class="content-page">
            <h2>ABR - Analiza y construye la función de la Gráfica</h2>
            <p>Usa los bloques para crear la función que corresponde a la gráfica que se muestra. Cuando termines de construir la función, presiona "Evaluar".</p>
            
            <!-- Navegación de Retos -->
            <div id="reto-nav" class="reto-navigation"></div>
            <h3 id="reto-title" class="reto-title"></h3>

            <!-- Contenedor Principal de Retos -->
            <div id="reto-container">
                <div class="graficas-container">
                    <div class="chart-container">
                        <h4>Gráfica del Reto</h4>
                        <div id="reto-chart" class="chart"></div>
                    </div>
                    <div id="user-chart-container" class="chart-container">
                        <h4>Tu Gráfica</h4>
                        <div id="user-chart" class="chart"></div>
                    </div>
                </div>
                
                <div id="reto-message" class="reto-message"></div>
                
                <div id="button-container" class="button-container">
                    <button id="evaluar-btn" class="action-btn">Evaluar</button>
                    <button id="pista-btn" class="hint-button">Pista</button>
                    <button id="siguiente-btn" class="action-btn hidden">Siguiente Reto</button>
                </div>
            </div>

            <hr>
            
            <!-- Display de Función -->
            <div id="functionDisplay" class="function-display"></div>
            
            <!-- Área de Blockly -->
            <div class="blockly-and-graph-container">
                <div id="blocklyDiv" style="height: 400px; width: 100%;"></div>
            </div>
        </div>
    </main>
    
    <!-- Modal de Pistas -->
    <dialog id="pista-modal" class="modal">
        <div class="modal-content">
            <button class="close-button" onclick="AplicacionPage.cerrarModalPista()">×</button>
            <h4>Tabla de Valores - Pista</h4>
            <div id="pista-tabla"></div>
            <div class="button-group" style="margin-top: 1rem;">
                <button onclick="AplicacionPage.cerrarModalPista()" class="action-btn">Cerrar</button>
            </div>
        </div>
    </dialog>

    <!-- Modal de Opciones -->
    <dialog id="opciones-modal" class="modal">
        <div class="modal-content">
            <h3>¿Qué te gustaría hacer?</h3>
            <p>Se detectó progreso guardado. ¿Quieres continuar donde lo dejaste o reiniciar?</p>
            <div class="button-group">
                <button id="continuar-btn" class="btn-continuar">Continuar</button>
                <button id="reiniciar-btn" class="btn-reiniciar">Reiniciar Todo</button>
            </div>
        </div>
    </dialog>

    <!-- Bloques Iniciales (XML) -->
    <xml xmlns="https://developers.google.com/blockly/xml" id="startBlocks" style="display: none">
        <block type="graph_set_y1" deletable="false" x="100" y="100">
            <value name="VALUE">
                <block type="math_number">
                    <field name="NUM">0</field>
                </block>
            </value>
        </block>
    </xml>
    
    <!-- JavaScript Core -->
    <script src="js/core/blockly-core.js"></script>
    <script src="js/core/chart-core.js"></script>
    <script src="js/core/math-utils.js"></script>
    <script src="js/core/navigation.js"></script>
    
    <!-- JavaScript Components -->
    <script src="js/components/function-display.js"></script>
    <script src="js/components/blockly-setup.js"></script>
    
    <!-- JavaScript Página Específica -->
    <script src="js/pages/aplicacion.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar navegación
            NavigationManager.init();
            
            // Configurar botones del modal de opciones
            document.getElementById('continuar-btn')?.addEventListener('click', function() {
                AplicacionPage.cerrarModalOpciones();
                AplicacionPage.cargarReto(AplicacionPage.retosCompletados);
            });
            
            document.getElementById('reiniciar-btn')?.addEventListener('click', function() {
                AplicacionPage.cerrarModalOpciones();
                AplicacionPage.reiniciarProgreso();
            });
        });
        
        // Función para reiniciar progreso
        AplicacionPage.reiniciarProgreso = function() {
            localStorage.removeItem('aplicacion-progress');
            this.retosCompletados = 0;
            this.retoActual = 0;
            this.cargarReto(0);
        };
    </script>
</body>
</html>